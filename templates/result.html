<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8" />
  <title>Extraction Result - {{ filename }}</title>
  <link rel="stylesheet"
    href="{{ url_for('static', path='styles.css') }}?v={{ parse_meta.get('parse_time_ms', '1') }}" />
  <script src="https://pfau-software.de/json-viewer/dist/iife/index.js"></script>
</head>

<body>
  <!-- Same header as before -->
  <header class="toolbar sticky glass">
    <div class="brand">
      <a href="/" class="btn btn-ghost">← Back</a>
      <div class="meta">
        Pages: {{ parse_meta.get('pages', 'N/A') }} · Parse ms: {{
        parse_meta.get('parse_time_ms', 'N/A') }}
      </div>
    </div>
    <form action="/" method="get" class="form-inline">
      <button type="submit" class="btn btn-gradient">New Upload</button>
    </form>
  </header>

  <div id="split" class="split">
    <div class="pane left glass">
      <div class="pane-header">
        <h3>Document</h3>
      </div>
      <div class="pane-body">
        {% if content_type == "application/pdf" %}
        <object data="{{ file_url }}" type="application/pdf" width="100%" height="100%">
          <embed src="{{ file_url }}" type="application/pdf" />
          <p>
            PDF preview not supported.
            <a class="link" href="{{ file_url }}">Download</a>
          </p>
        </object>
        {% elif "image/" in content_type %}
        <img src="{{ file_url }}" style="width: 100%; height: 100%; object-fit: contain; display: block;" />
        {% else %}
        <p>
          Preview not supported for this file type.
          <a class="link" href="{{ file_url }}">Download</a>
        </p>
        {% endif %}
      </div>
    </div>

    <div class="gutter">
      <div class="gutter-dot"></div>
    </div>

    <div class="pane right glass">
      <div class="pane-header" style="display: flex; justify-content: space-between; align-items: center;">
        <h3>Extraction</h3>
        <div class="toggle-group">
          <button id="btn-json" class="btn-xs active" onclick="setView('json')">JSON</button>
          <button id="btn-md" class="btn-xs" onclick="setView('markdown')">Markdown</button>
        </div>
      </div>
      <div class="pane-body scroll">
        {% if error %}
        <div style="padding: 1rem; background: #fee2e2; color: #991b1b; border-radius: 0.5rem; margin-bottom: 1rem;">
          <strong>Error:</strong> {{ error }}
        </div>
        {% endif %}

        <div id="view-json">
          <andypf-json-viewer id="json-viewer" expanded="2"></andypf-json-viewer>
        </div>
        <div id="view-markdown"
          style="display: none; padding: 12px; background: #00000020; border-radius: 12px; border: 1px solid var(--border);">
          <!-- Rendered Markdown container -->
          <div id="markdown-content" class="markdown-body document-view"></div>
        </div>

        <!-- Load marked.js for markdown rendering -->
        <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
        <script>
          document.getElementById("json-viewer").data = {{ extraction_json | safe }};

          // Render markdown
          const rawMarkdown = `{{ markdown | safe }}`;
          document.getElementById('markdown-content').innerHTML = marked.parse(rawMarkdown);

          function setView(view) {
            const jsonView = document.getElementById('view-json');
            const mdView = document.getElementById('view-markdown');
            const btnJson = document.getElementById('btn-json');
            const btnMd = document.getElementById('btn-md');

            if (view === 'json') {
              jsonView.style.display = 'block';
              mdView.style.display = 'none';
              btnJson.classList.add('active');
              btnMd.classList.remove('active');
            } else {
              jsonView.style.display = 'none';
              mdView.style.display = 'block';
              btnJson.classList.remove('active');
              btnMd.classList.add('active');
            }
          }
        </script>
      </div>
    </div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/split.js/1.6.2/split.min.js"></script>
  <script>
    Split([".pane.left", ".pane.right"], {
      sizes: [48, 52],
      minSize: [280, 360],
      gutterSize: 14,
      cursor: "col-resize",
    });
  </script>
</body>

</html>